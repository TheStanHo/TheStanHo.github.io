{"componentChunkName":"component---node-modules-gatsby-theme-portfolio-minimal-src-templates-article-index-tsx","path":"/GrafanaProvisioning/","result":{"pageContext":{"article":{"banner":{"alt":"Metrics","caption":"Photo by <u><a href=\"https://unsplash.com/photos/turned-on-monitoring-screen-qwtCeJ5cLYs\">Stephen Dawson</a></u>","src":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#585858","images":{"fallback":{"src":"/static/01a8e7547004c99cd7fcc8d5104d2f08/91671/stephen-dawson-qwtCeJ5cLYs-unsplash.jpg","srcSet":"/static/01a8e7547004c99cd7fcc8d5104d2f08/7e3b4/stephen-dawson-qwtCeJ5cLYs-unsplash.jpg 165w,\n/static/01a8e7547004c99cd7fcc8d5104d2f08/47f88/stephen-dawson-qwtCeJ5cLYs-unsplash.jpg 330w,\n/static/01a8e7547004c99cd7fcc8d5104d2f08/91671/stephen-dawson-qwtCeJ5cLYs-unsplash.jpg 660w,\n/static/01a8e7547004c99cd7fcc8d5104d2f08/5aaff/stephen-dawson-qwtCeJ5cLYs-unsplash.jpg 1320w","sizes":"(min-width: 660px) 660px, 100vw"},"sources":[{"srcSet":"/static/01a8e7547004c99cd7fcc8d5104d2f08/322ad/stephen-dawson-qwtCeJ5cLYs-unsplash.webp 165w,\n/static/01a8e7547004c99cd7fcc8d5104d2f08/de3b3/stephen-dawson-qwtCeJ5cLYs-unsplash.webp 330w,\n/static/01a8e7547004c99cd7fcc8d5104d2f08/2b2b5/stephen-dawson-qwtCeJ5cLYs-unsplash.webp 660w,\n/static/01a8e7547004c99cd7fcc8d5104d2f08/e36a7/stephen-dawson-qwtCeJ5cLYs-unsplash.webp 1320w","type":"image/webp","sizes":"(min-width: 660px) 660px, 100vw"}]},"width":660,"height":400}}}},"body":"<h2>Introduction</h2>\n<p>Having spent time in my DevOps career using Grafana and maintaining it. I've never actually had the chance to deploy it from scratch, especially the newer version. Since the versions that I have used have all been &#x3C; v9.0. I can presume that the current latest version of v10.2 probably has a lot of new features and changes.</p>\n<p>This blog is written on how I deployed Grafana and provisoned the Dashboard, Alerts, Datasources, Contact points (Since they had broken down Notifcations channels into Notification Policies and Contact Points) and Notification Policies. Luckily enough, I set up a sandbox environment as mentioned in an <a href=\"https://thestanho.github.io/SettingUpAPersonalSandbox/\">early blog</a> which I will be using to deploy Grafana too. This is far better than Minikube in my opinion as personally it tends not to work that well for me, or I'm just not well versed in the workings of it.</p>\n<ul>\n<li>The helmchart used can be found here on <a href=\"https://artifacthub.io/packages/helm/grafana/grafana\">ArtifactHub</a> or via the source on <a href=\"https://github.com/grafana/helm-charts/tree/main/charts/grafana\">Github</a></li>\n<li>The Azure DevOps Yaml pipeline I used to deploy can be found below.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">trigger</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token boolean important\">false</span>\r\n<span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">repo</span><span class=\"token punctuation\">:</span> self\r\n<span class=\"token key atrule\">pool</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">vmImage</span><span class=\"token punctuation\">:</span> windows<span class=\"token punctuation\">-</span>latest\r\n<span class=\"token key atrule\">variables</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> serviceConnectionName\r\n    <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;updateMe!>\"</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> resourceGroupName\r\n    <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;updateMe!>\"</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> AKSClusterName\r\n    <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;updateMe!>\"</span>\r\n<span class=\"token key atrule\">stages</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> Helm\r\n    <span class=\"token key atrule\">displayName</span><span class=\"token punctuation\">:</span> Helm\r\n    <span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job</span><span class=\"token punctuation\">:</span> Helm\r\n      <span class=\"token key atrule\">displayName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Helm\"</span>\r\n      <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">task</span><span class=\"token punctuation\">:</span> HelmInstaller@0\r\n          <span class=\"token key atrule\">displayName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'Install Helm 2.14.1'</span>\r\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">task</span><span class=\"token punctuation\">:</span> HelmDeploy@0\r\n          <span class=\"token key atrule\">displayName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'helm upgrade'</span>\r\n          <span class=\"token key atrule\">inputs</span><span class=\"token punctuation\">:</span>\r\n            <span class=\"token key atrule\">azureSubscription</span><span class=\"token punctuation\">:</span> $(serviceConnectionName)\r\n            <span class=\"token key atrule\">azureResourceGroup</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'$(resourceGroupName)'</span>\r\n            <span class=\"token key atrule\">kubernetesCluster</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'$(AKSClusterName)'</span>\r\n            <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\r\n            <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> upgrade\r\n            <span class=\"token key atrule\">chartType</span><span class=\"token punctuation\">:</span> FilePath\r\n            <span class=\"token key atrule\">chartPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'grafana'</span>\r\n            <span class=\"token key atrule\">releaseName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'grafana'</span>\r\n            <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'--install'</span></code></pre></div>\n<h2>Provisioning Set up - Helmchart</h2>\n<p>To enable provisioning of the dashboards, alerts, datasources etc. We need to enable the sidecars that will help pick up the configmaps/secrets used to deploy these resources. To do this in the Grafana values.yaml enable and set the following values.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">sidecar</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">alerts</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n    <span class=\"token comment\"># label that the configmaps with alert are marked with</span>\r\n    <span class=\"token key atrule\">label</span><span class=\"token punctuation\">:</span> grafana_alert\r\n    <span class=\"token comment\"># value of label that the configmaps with alert are set to</span>\r\n    <span class=\"token key atrule\">labelValue</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"provision\"</span>\r\n    <span class=\"token comment\"># If specified, the sidecar will search for alert config-maps inside this namespace.</span>\r\n    <span class=\"token comment\"># Otherwise the namespace in which the sidecar is running will be used.</span>\r\n    <span class=\"token comment\"># It's also possible to specify ALL to search in all namespaces</span>\r\n    <span class=\"token key atrule\">searchNamespace</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\r\n    <span class=\"token comment\"># Method to use to detect ConfigMap changes. With WATCH the sidecar will do a WATCH requests, with SLEEP it will list all ConfigMaps, then sleep for 60 seconds.</span>\r\n    <span class=\"token key atrule\">watchMethod</span><span class=\"token punctuation\">:</span> WATCH\r\n    <span class=\"token comment\"># search in configmap, secret or both</span>\r\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> both\r\n  <span class=\"token key atrule\">dashboards</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n    <span class=\"token comment\"># label that the configmaps with dashboards are marked with</span>\r\n    <span class=\"token key atrule\">label</span><span class=\"token punctuation\">:</span> grafana_dashboard\r\n    <span class=\"token comment\"># value of label that the configmaps with dashboards are set to</span>\r\n    <span class=\"token key atrule\">labelValue</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"provision\"</span>\r\n    <span class=\"token comment\"># If specified, the sidecar will search for alert config-maps inside this namespace.</span>\r\n    <span class=\"token comment\"># Otherwise the namespace in which the sidecar is running will be used.</span>\r\n    <span class=\"token comment\"># It's also possible to specify ALL to search in all namespaces</span>\r\n    <span class=\"token key atrule\">searchNamespace</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\r\n    <span class=\"token comment\"># Method to use to detect ConfigMap changes. With WATCH the sidecar will do a WATCH requests, with SLEEP it will list all ConfigMaps, then sleep for 60 seconds.</span>\r\n    <span class=\"token key atrule\">watchMethod</span><span class=\"token punctuation\">:</span> WATCH\r\n    <span class=\"token comment\"># search in configmap, secret or both</span>\r\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> both\r\n    <span class=\"token comment\"># If specified, the sidecar will look for annotation with this name to create folder and put graph here.</span>\r\n    <span class=\"token comment\"># You can use this parameter together with `provider.foldersFromFilesStructure`to annotate configmaps and create folder structure.</span>\r\n    <span class=\"token key atrule\">folderAnnotation</span><span class=\"token punctuation\">:</span> grafana_dashboard_folder\r\n    <span class=\"token key atrule\">provider</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token comment\"># disableDelete to activate a import-only behaviour</span>\r\n      <span class=\"token key atrule\">disableDelete</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n      <span class=\"token comment\"># allow updating provisioned dashboards from the UI</span>\r\n      <span class=\"token key atrule\">allowUiUpdates</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n      <span class=\"token comment\"># allow Grafana to replicate dashboard structure from filesystem</span>\r\n      <span class=\"token key atrule\">foldersFromFilesStructure</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n  <span class=\"token key atrule\">datasources</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n    <span class=\"token key atrule\">label</span><span class=\"token punctuation\">:</span> grafana_datasource\r\n    <span class=\"token comment\"># value of label that the configmaps with datasources are set to</span>\r\n    <span class=\"token key atrule\">labelValue</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"provision\"</span>\r\n    <span class=\"token comment\"># Log level. Can be one of: DEBUG, INFO, WARN, ERROR, CRITICAL.</span>\r\n    <span class=\"token comment\"># logLevel: INFO</span>\r\n    <span class=\"token comment\"># If specified, the sidecar will search for datasource config-maps inside this namespace.</span>\r\n    <span class=\"token comment\"># Otherwise the namespace in which the sidecar is running will be used.</span>\r\n    <span class=\"token comment\"># It's also possible to specify ALL to search in all namespaces</span>\r\n    <span class=\"token key atrule\">searchNamespace</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\r\n    <span class=\"token comment\"># Method to use to detect ConfigMap changes. With WATCH the sidecar will do a WATCH requests, with SLEEP it will list all ConfigMaps, then sleep for 60 seconds.</span>\r\n    <span class=\"token key atrule\">watchMethod</span><span class=\"token punctuation\">:</span> WATCH\r\n    <span class=\"token comment\"># search in configmap, secret or both</span>\r\n    <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span> both</code></pre></div>\n<p><strong>Note</strong>: I don't install the plugin's via this method since as it staes in their documentation (yes sometimes I actually read it) <a href=\"https://grafana.com/docs/grafana/latest/administration/provisioning/#plugins\">here</a>, that the feature enables the provisioning of plugin configuration but not of the plugins themselves, so it is just easier to set the required plugins in the values.yaml.</p>\n<p>So above is just the main configuration that I set in the values.yaml for the Grafana helmchart to allow me to provsion via configmaps and secrets. Things I've learned when trying to do so:</p>\n<ol>\n<li>Remember to set the labelValue, this is important for the sidecar to pick up the configmap or secret. I believe in the values.yaml they left it as \"\" blank so you have to set is value and match it with the label value you set for your configmap/secret.</li>\n<li>I found it useful to just manually create the bits I required in Grafana and then exported the yaml of it to help set the yaml that I required.</li>\n</ol>\n<h2>Provisoning the Grafana resources</h2>\n<h3>Dashboard</h3>\n<p>One thing to remember for this is that if you want to put your dashboard in a specific folder then add the annotation <em>\"grafana_dashboard_folder\"</em> and make sure that in the values.yaml file, that your <em>\"folderAnnotation\"</em> value is set</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dashboard<span class=\"token punctuation\">-</span>one\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n     <span class=\"token key atrule\">grafana_dashboard</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"provision\"</span>\r\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span> \r\n    <span class=\"token key atrule\">grafana_dashboard_folder</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Dashboard one\"</span>\r\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">dashboard-one.json</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\r\n    &lt;Dashboard.json file contents here<span class=\"token punctuation\">></span></code></pre></div>\n<h3>Datasource</h3>\n<p>To test this I actually deployed a <a href=\"https://github.com/prometheus-community/helm-charts\">Prometheus</a> instance on my AKS, so that I have a working datasource I could actually add to it.</p>\n<p><a href=\"https://grafana.com/docs/grafana/latest/datasources/\">Documentation about datasources</a>. Helpful documentation with core datasources and also links to how to provsion them.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> datasources\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">grafana_datasource</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'provision'</span> \r\n<span class=\"token key atrule\">stringData</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">datasources.yaml</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\r\n    <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n    <span class=\"token key atrule\">datasources</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Prometheus<span class=\"token punctuation\">-</span>Production\r\n        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> prometheus\r\n        <span class=\"token comment\"># Access mode - proxy (server in the UI) or direct (browser in the UI).</span>\r\n        <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//10.244.0.38<span class=\"token punctuation\">:</span><span class=\"token number\">9090</span>\r\n        <span class=\"token key atrule\">jsonData</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token key atrule\">httpMethod</span><span class=\"token punctuation\">:</span> POST\r\n          <span class=\"token key atrule\">manageAlerts</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n          <span class=\"token key atrule\">prometheusType</span><span class=\"token punctuation\">:</span> Prometheus\r\n          <span class=\"token comment\">#prometheusVersion: 2.44.0</span>\r\n          <span class=\"token key atrule\">cacheLevel</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'low'</span>\r\n          <span class=\"token key atrule\">disableRecordingRules</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n          <span class=\"token key atrule\">incrementalQueryOverlapWindow</span><span class=\"token punctuation\">:</span> 10m\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Prometheus<span class=\"token punctuation\">-</span>Test\r\n        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> prometheus\r\n        <span class=\"token comment\"># Access mode - proxy (server in the UI) or direct (browser in the UI).</span>\r\n        <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//10.244.0.38<span class=\"token punctuation\">:</span><span class=\"token number\">9090</span>\r\n        <span class=\"token key atrule\">jsonData</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token key atrule\">httpMethod</span><span class=\"token punctuation\">:</span> POST\r\n          <span class=\"token key atrule\">manageAlerts</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n          <span class=\"token key atrule\">prometheusType</span><span class=\"token punctuation\">:</span> Prometheus\r\n          <span class=\"token comment\">#prometheusVersion: 2.44.0</span>\r\n          <span class=\"token key atrule\">cacheLevel</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'low'</span>\r\n          <span class=\"token key atrule\">disableRecordingRules</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n          <span class=\"token key atrule\">incrementalQueryOverlapWindow</span><span class=\"token punctuation\">:</span> 10m</code></pre></div>\n<h3>Alerts</h3>\n<p><strong>Note:</strong> Make sure to label your alert when creating it! To be used in the notification policies!</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> grafana<span class=\"token punctuation\">-</span>alert\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n     <span class=\"token key atrule\">grafana_alert</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"provision\"</span>\r\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">alerts.yaml</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\r\n        <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n        <span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span>\r\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">orgId</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n            <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Alerts<span class=\"token punctuation\">-</span>Test\r\n            <span class=\"token key atrule\">folder</span><span class=\"token punctuation\">:</span> Alerting Dashboards\r\n            <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 5m\r\n            <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\r\n                <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uid</span><span class=\"token punctuation\">:</span> &lt;UID<span class=\"token punctuation\">></span>\r\n                <span class=\"token key atrule\">title</span><span class=\"token punctuation\">:</span> Alert<span class=\"token punctuation\">-</span>Demo\r\n                <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> C\r\n                <span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\r\n                    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">refId</span><span class=\"token punctuation\">:</span> A\r\n                    <span class=\"token key atrule\">relativeTimeRange</span><span class=\"token punctuation\">:</span>\r\n                        <span class=\"token key atrule\">from</span><span class=\"token punctuation\">:</span> <span class=\"token number\">600</span>\r\n                        <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\r\n                    <span class=\"token key atrule\">datasourceUid</span><span class=\"token punctuation\">:</span> &lt;datasourceUID<span class=\"token punctuation\">></span>\r\n                    <span class=\"token key atrule\">model</span><span class=\"token punctuation\">:</span>\r\n                        <span class=\"token key atrule\">disableTextWrap</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n                        <span class=\"token key atrule\">editorMode</span><span class=\"token punctuation\">:</span> builder\r\n                        <span class=\"token key atrule\">expr</span><span class=\"token punctuation\">:</span> aggregator_discovery_aggregation_count_total<span class=\"token punctuation\">{</span>agentpool=\"default\"<span class=\"token punctuation\">}</span>\r\n                        <span class=\"token key atrule\">fullMetaSearch</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n                        <span class=\"token key atrule\">includeNullMetadata</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n                        <span class=\"token key atrule\">instant</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n                        <span class=\"token key atrule\">intervalMs</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\r\n                        <span class=\"token key atrule\">legendFormat</span><span class=\"token punctuation\">:</span> __auto\r\n                        <span class=\"token key atrule\">maxDataPoints</span><span class=\"token punctuation\">:</span> <span class=\"token number\">43200</span>\r\n                        <span class=\"token key atrule\">range</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n                        <span class=\"token key atrule\">refId</span><span class=\"token punctuation\">:</span> A\r\n                        <span class=\"token key atrule\">useBackend</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n                    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">refId</span><span class=\"token punctuation\">:</span> B\r\n                    <span class=\"token key atrule\">relativeTimeRange</span><span class=\"token punctuation\">:</span>\r\n                        <span class=\"token key atrule\">from</span><span class=\"token punctuation\">:</span> <span class=\"token number\">600</span>\r\n                        <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\r\n                    <span class=\"token key atrule\">datasourceUid</span><span class=\"token punctuation\">:</span> __expr__\r\n                    <span class=\"token key atrule\">model</span><span class=\"token punctuation\">:</span>\r\n                        <span class=\"token key atrule\">conditions</span><span class=\"token punctuation\">:</span>\r\n                            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">evaluator</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n                                <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> gt\r\n                            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> and\r\n                            <span class=\"token key atrule\">query</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\r\n                                    <span class=\"token punctuation\">-</span> B\r\n                            <span class=\"token key atrule\">reducer</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n                                <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> last\r\n                            <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> query\r\n                        <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\r\n                            <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> __expr__\r\n                            <span class=\"token key atrule\">uid</span><span class=\"token punctuation\">:</span> __expr__\r\n                        <span class=\"token key atrule\">expression</span><span class=\"token punctuation\">:</span> A\r\n                        <span class=\"token key atrule\">intervalMs</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\r\n                        <span class=\"token key atrule\">maxDataPoints</span><span class=\"token punctuation\">:</span> <span class=\"token number\">43200</span>\r\n                        <span class=\"token key atrule\">reducer</span><span class=\"token punctuation\">:</span> last\r\n                        <span class=\"token key atrule\">refId</span><span class=\"token punctuation\">:</span> B\r\n                        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> reduce\r\n                    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">refId</span><span class=\"token punctuation\">:</span> C\r\n                    <span class=\"token key atrule\">relativeTimeRange</span><span class=\"token punctuation\">:</span>\r\n                        <span class=\"token key atrule\">from</span><span class=\"token punctuation\">:</span> <span class=\"token number\">600</span>\r\n                        <span class=\"token key atrule\">to</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\r\n                    <span class=\"token key atrule\">datasourceUid</span><span class=\"token punctuation\">:</span> __expr__\r\n                    <span class=\"token key atrule\">model</span><span class=\"token punctuation\">:</span>\r\n                        <span class=\"token key atrule\">conditions</span><span class=\"token punctuation\">:</span>\r\n                            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">evaluator</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\r\n                                    <span class=\"token punctuation\">-</span> <span class=\"token number\">0</span>\r\n                                <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> gt\r\n                            <span class=\"token key atrule\">operator</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> and\r\n                            <span class=\"token key atrule\">query</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\r\n                                    <span class=\"token punctuation\">-</span> C\r\n                            <span class=\"token key atrule\">reducer</span><span class=\"token punctuation\">:</span>\r\n                                <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n                                <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> last\r\n                            <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> query\r\n                        <span class=\"token key atrule\">datasource</span><span class=\"token punctuation\">:</span>\r\n                            <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> __expr__\r\n                            <span class=\"token key atrule\">uid</span><span class=\"token punctuation\">:</span> __expr__\r\n                        <span class=\"token key atrule\">expression</span><span class=\"token punctuation\">:</span> B\r\n                        <span class=\"token key atrule\">intervalMs</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span>\r\n                        <span class=\"token key atrule\">maxDataPoints</span><span class=\"token punctuation\">:</span> <span class=\"token number\">43200</span>\r\n                        <span class=\"token key atrule\">refId</span><span class=\"token punctuation\">:</span> C\r\n                        <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> threshold\r\n                <span class=\"token key atrule\">noDataState</span><span class=\"token punctuation\">:</span> NoData\r\n                <span class=\"token key atrule\">execErrState</span><span class=\"token punctuation\">:</span> Error\r\n                <span class=\"token key atrule\">for</span><span class=\"token punctuation\">:</span> 5m\r\n                <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\r\n                    <span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\r\n                    <span class=\"token key atrule\">runbook_url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\r\n                    <span class=\"token key atrule\">summary</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\r\n                <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n                    <span class=\"token key atrule\">\"\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\r\n                    <span class=\"token key atrule\">team</span><span class=\"token punctuation\">:</span> Marvel\r\n                <span class=\"token key atrule\">isPaused</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code></pre></div>\n<h3>Contact Points</h3>\n<p>Contact points is basically your notification channels, from legacy Grafana. Since Notifications channels were split into Contact Points and Notification Policy.\r\n<a href=\"https://grafana.com/docs/grafana/latest/alerting/fundamentals/contact-points/#contact-points\">Documentation on contact points</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Secret\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> contact<span class=\"token punctuation\">-</span>point\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">grafana_alert</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"provision\"</span> \r\n<span class=\"token key atrule\">stringData</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">contact-points.yaml</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\r\n    <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n    <span class=\"token key atrule\">contactPoints</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">orgId</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>Marvel\r\n          <span class=\"token key atrule\">receivers</span><span class=\"token punctuation\">:</span>\r\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uid</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>Marvel\r\n              <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> email\r\n              <span class=\"token key atrule\">settings</span><span class=\"token punctuation\">:</span>\r\n                <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>Marvel@hotmail.co.uk\r\n                <span class=\"token key atrule\">singleEmail</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n              <span class=\"token key atrule\">disableResolveMessage</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\r\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">orgId</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n          <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>DC\r\n          <span class=\"token key atrule\">receivers</span><span class=\"token punctuation\">:</span>\r\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uid</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>DC\r\n              <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> email\r\n              <span class=\"token key atrule\">settings</span><span class=\"token punctuation\">:</span>\r\n                <span class=\"token key atrule\">addresses</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>DC@hotmail.co.uk\r\n                <span class=\"token key atrule\">singleEmail</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n              <span class=\"token key atrule\">disableResolveMessage</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span></code></pre></div>\n<h3>Notification Policies</h3>\n<p>You see here for notification policies I have <em>\"object_matchers\"</em> which will link the notification policy to the alert that was created. Hence, why it is important to label you alerts, so you can help define which notification policy route it is routed to and to which contact point.\r\n<a href=\"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notification-policies/#notification-policies\">Documentation on Notification Policies</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\r\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\r\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> notification<span class=\"token punctuation\">-</span>policies\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">grafana_alert</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"provision\"</span> \r\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">notification-policies.yaml</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token punctuation\">-</span>\r\n    <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n    <span class=\"token key atrule\">policies</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">orgId</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\r\n        <span class=\"token key atrule\">receiver</span><span class=\"token punctuation\">:</span> grafana<span class=\"token punctuation\">-</span>default<span class=\"token punctuation\">-</span>email\r\n        <span class=\"token key atrule\">group_by</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'...'</span><span class=\"token punctuation\">]</span>\r\n        <span class=\"token key atrule\">routes</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">receiver</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>Marvel\r\n            <span class=\"token key atrule\">object_matchers</span><span class=\"token punctuation\">:</span>\r\n              <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'team'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'='</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Marvel'</span><span class=\"token punctuation\">]</span>\r\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">receiver</span><span class=\"token punctuation\">:</span> Team<span class=\"token punctuation\">-</span>DC\r\n            <span class=\"token key atrule\">object_matchers</span><span class=\"token punctuation\">:</span>\r\n              <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'team'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'='</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'DC'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>Personally, I've learned quite alot trying to implement this in my sandbox. I've learned how the new Grafana version works especially with the new way that alerting is implemented with the newer version of Grafana. I've also noticed it will be such a pain to migrate old dashboards on older versions of Grafana to newer Versions of Grafana. (Although, hopefully there is some documentation I missed talking about such a migration!).</p>\n<p>Also, with this kind of provisioning of such dashboards and alerts via configmaps it could allow development teams to provsion their own dashboards as part of their Helm releases so that as well as deploying their app they have a way of monitoring and alerting set up also for their applications.</p>","categories":["Monitoring","AKS","Kubernetes"],"date":"January 19, 2024","description":"Grafana Provisioning via helmcharts","id":"596815bb-ebd2-5a0d-926d-7b6c0e3a887f","keywords":["Monitoring","Grafana","Kubernetes","AKS","Provisioning","Blog"],"slug":"/GrafanaProvisioning/","title":"Grafana Provisioning","readingTime":{"text":"8 min read"}},"listingPagePath":"/blog"}},"staticQueryHashes":["172304273","1764120992","2442753764","2572006233","3525841079","513457919","540466502","597217301","948380417"],"slicesMap":{}}