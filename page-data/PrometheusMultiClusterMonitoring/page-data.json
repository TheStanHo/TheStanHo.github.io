{"componentChunkName":"component---node-modules-gatsby-theme-portfolio-minimal-src-templates-article-index-tsx","path":"/PrometheusMultiClusterMonitoring/","result":{"pageContext":{"article":{"banner":{"alt":"Prometheus Greek God","caption":"Photo by <u><a href=\"https://unsplash.com/photos/PkZo8mERNak\">Christian Paul Stobbe</a></u>","src":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#784828","images":{"fallback":{"src":"/static/70d1bcd6001188efae8641ddab2f4531/91671/christian-paul-stobbe-PkZo8mERNak-unsplash.jpg","srcSet":"/static/70d1bcd6001188efae8641ddab2f4531/7e3b4/christian-paul-stobbe-PkZo8mERNak-unsplash.jpg 165w,\n/static/70d1bcd6001188efae8641ddab2f4531/47f88/christian-paul-stobbe-PkZo8mERNak-unsplash.jpg 330w,\n/static/70d1bcd6001188efae8641ddab2f4531/91671/christian-paul-stobbe-PkZo8mERNak-unsplash.jpg 660w,\n/static/70d1bcd6001188efae8641ddab2f4531/5aaff/christian-paul-stobbe-PkZo8mERNak-unsplash.jpg 1320w","sizes":"(min-width: 660px) 660px, 100vw"},"sources":[{"srcSet":"/static/70d1bcd6001188efae8641ddab2f4531/322ad/christian-paul-stobbe-PkZo8mERNak-unsplash.webp 165w,\n/static/70d1bcd6001188efae8641ddab2f4531/de3b3/christian-paul-stobbe-PkZo8mERNak-unsplash.webp 330w,\n/static/70d1bcd6001188efae8641ddab2f4531/2b2b5/christian-paul-stobbe-PkZo8mERNak-unsplash.webp 660w,\n/static/70d1bcd6001188efae8641ddab2f4531/e36a7/christian-paul-stobbe-PkZo8mERNak-unsplash.webp 1320w","type":"image/webp","sizes":"(min-width: 660px) 660px, 100vw"}]},"width":660,"height":400}}}},"body":"<p>Each of us manages multiple AKS clusters across various environments, and we want Prometheus to monitor them. One of the challenges we face is effectively monitoring environments with multiple clusters, which can be the case in certain test or production environments(hopefully).</p>\n<p>Though there are solutions such as:</p>\n<ul>\n<li>Prometheus Federation</li>\n<li>Thanos (Not the Marvel one!)</li>\n</ul>\n<p>The simplest option I came across is the Prometheus agent introduced in Prometheus version 2.32.0. The agent mode deactivates certain features typically present in the Prometheus server, focusing solely on discovery, scraping, and remote write functions. This design choice is aimed at enhancing the performance of the Prometheus agent.</p>\n<h2>Overview of the set up</h2>\n<p>In my opinion and experience the best way to implement this is shown in the diagram below.</p>\n<style>\r\n  .container {\r\n    overflow: scroll !important;\r\n    white-space: nowrap;\r\n    max-width: 300px;\r\n    max-height: 300px;\r\n  }\r\n  img {\r\n    max-width: 1000%;\r\n  }\r\n</style>\n<div class=\"container\">\n  <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 660px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 63.03030303030304%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABpklEQVR42pVT22rcMBD1//9GoW95SUvYh0KghQ2mWUL6EBo2LKRJaTfeiy+ybjPSKRpbzqZJehkQkubMHJ/xjAqMFmNECFHOV/MKX04fBn/AM0uxr1lxGJQDm22P1aqF8QFEHt57OE+oaoKn8Cz+VcJBUdoj3pUdLm8UIlsYo1G3Fm8+1Ni1/t8JE552Zsas3OJ7pYU8xgClGSdlDefo/wgTgfeE4/kOd2sNJgdnDR62Ckef9jD2LwozcLiSQnI9mDxCSP+RRCVAgr2Uk8mLP3UsWSYcVL0ck/2JS0pmHpKUUrIcGXSqgzFGFKUuJ2KtNVTfodcKXafkPgg6ULi+1ekq3U3Jad1dN2hrixDDb2UFdLUVjAPLR5gC2p0DjeNUfD1bj6U91jM//gbX2CflZPzz7AduzjdTbL0xOH17CwQeCC9XBoulEdlh7DIFxuy8R61oKidPAXuLi2WH+42fRupnpbBYalFcLK47lFfNE0LrPN6f7bGdVA6EGT8pG1wslZyT3VcWRx/38poKIEnlqSRJ5Ozjxxc07jI2gRCYJGcYMxJfwn4BinH3kl049NwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <picture>\n          <source srcset=\"/static/cdd2583c49b42db1fadd0844b226940a/c9b55/GenericArchitecture.pdf.webp 165w,\n/static/cdd2583c49b42db1fadd0844b226940a/f2908/GenericArchitecture.pdf.webp 330w,\n/static/cdd2583c49b42db1fadd0844b226940a/cc661/GenericArchitecture.pdf.webp 660w,\n/static/cdd2583c49b42db1fadd0844b226940a/a66df/GenericArchitecture.pdf.webp 990w,\n/static/cdd2583c49b42db1fadd0844b226940a/d33d4/GenericArchitecture.pdf.webp 1320w,\n/static/cdd2583c49b42db1fadd0844b226940a/bc4fa/GenericArchitecture.pdf.webp 1985w\" sizes=\"(max-width: 660px) 100vw, 660px\" type=\"image/webp\">\n          <source srcset=\"/static/cdd2583c49b42db1fadd0844b226940a/04c57/GenericArchitecture.pdf.png 165w,\n/static/cdd2583c49b42db1fadd0844b226940a/d9ecf/GenericArchitecture.pdf.png 330w,\n/static/cdd2583c49b42db1fadd0844b226940a/1f083/GenericArchitecture.pdf.png 660w,\n/static/cdd2583c49b42db1fadd0844b226940a/7a3d6/GenericArchitecture.pdf.png 990w,\n/static/cdd2583c49b42db1fadd0844b226940a/78958/GenericArchitecture.pdf.png 1320w,\n/static/cdd2583c49b42db1fadd0844b226940a/d413f/GenericArchitecture.pdf.png 1985w\" sizes=\"(max-width: 660px) 100vw, 660px\" type=\"image/png\">\n          <img class=\"gatsby-resp-image-image\" src=\"/static/cdd2583c49b42db1fadd0844b226940a/1f083/GenericArchitecture.pdf.png\" alt=\"GenericArchitecture pdf\" title=\"\" loading=\"lazy\" decoding=\"async\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n        </picture>\n    </span>\n</div>\n<p>In this model we will have:</p>\n<ul>\n<li>2 Instances of Prometheus Server -> One for Production and another for Non-production. You can run this on the same AKS or separate it if you want to split your non-prod and prod metrics.</li>\n<li>2 Instances of InfluxDB -> One for Production Prometheus server to remote write to and another for Non-production prometheus instance to remote write to. (Note that you are not restricted to InfluxDB and there are other options to use as Remote Endpoints and storage which can be found <a href=\"https://prometheus.io/docs/operating/integrations/#remote-endpoints-and-storage\">here</a>). Again you can run this on the same AKS or separate it if you want to split your non-prod and prod metrics.</li>\n<li>Multiple Prometheus agents that are set up in different environments to remoteWrite to our Prometheus Servers respectively.</li>\n</ul>\n<h2>Implementation</h2>\n<p>In this scenario we will already have set up an InfluxDB for Prometheus Server to write to. You can use this <a href=\"https://artifacthub.io/packages/helm/influxdata/influxdb\">InfluxDB Helmchart</a>, if you want to implement using InfluxDB as your remote endpoint and storage or use an alernative solution as mentioned in the previous section.</p>\n<ul>\n<li><a href=\"https://artifacthub.io/packages/helm/prometheus-community/prometheus\">Prometheus Helmchart</a></li>\n</ul>\n<h3>Prometheus Server configuration values</h3>\n<p>The below configuration does the following:</p>\n<ul>\n<li>The <a href=\"https://prometheus.io/docs/prometheus/latest/feature_flags/#remote-write-receiver\">web.enable-remote-write-receiver</a> enables the the /api/v1/write endpoint on the Prometheus Server</li>\n<li>Ingress is set up so that the Prometheus agent has a nice url to write to</li>\n<li>RemoteWrite and RemoteRead so that Prometheus server knows where to write and read too. Allowing us to retain data even with Prometheus restart. One thing to note is that if the Prometheus server cannot write to InfluxDB it will write and read data locally to/from the pod itself, the default retention is set to 15 days. So you will only get data for 15 days until the issue with writing to InfluxDB is resolved.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">extraFlags</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> web.enable<span class=\"token punctuation\">-</span>remote<span class=\"token punctuation\">-</span>write<span class=\"token punctuation\">-</span>receiver\r\n  <span class=\"token key atrule\">ingress</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n    <span class=\"token key atrule\">tls</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">secretName</span><span class=\"token punctuation\">:</span> tls <span class=\"token comment\">#secretName holding the TLS certificate information</span>\r\n        <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token punctuation\">-</span> prometheus<span class=\"token punctuation\">-</span>server.&lt;domain<span class=\"token punctuation\">></span>\r\n    <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> prometheus<span class=\"token punctuation\">-</span>server.&lt;domain<span class=\"token punctuation\">></span>\r\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">kubernetes.io/ingress.class</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"nginx\"</span>\r\n  <span class=\"token key atrule\">remoteWrite</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://influxdb-prod.&lt;domain>/api/v1/prom/write?db=prodPrometheus\"</span>\r\n  <span class=\"token key atrule\">remoteRead</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://influxdb-prod.&lt;domain>/api/v1/prom/read?db=prodPrometheus\"</span></code></pre></div>\n<h3>Prometheus Agent configuration</h3>\n<p>Note that I have found since we use defaultFlagsOverride to set this, we will need to put in additional arguments since you are overriding the default arguments that the Prometheus containers start up with.</p>\n<ul>\n<li>The <a href=\"https://prometheus.io/docs/prometheus/latest/feature_flags/#prometheus-agent\">enable-feature=agent</a> puts the Prometheus-server into agent mode</li>\n<li>The config.file is where the prometheus.yaml file is located</li>\n<li>The <a href=\"https://prometheus.io/docs/prometheus/latest/migration/#prometheus-lifecycle\">web.enable-lifecycle</a> allows HTTP Post request to be sent to the /-/reload endpoint so that it will reload any configmap/config when it is updated</li>\n<li>The remoteWrite is set to the Prometheus Server endpoint so that it can write data to that server</li>\n<li>The external_labels is used to add labels to the metric data that the Prometheus agent sends to the Prometheus server. Note that if you alreaedy have metrics any old data already written to storage will not have any external_labels appended to it, only new data.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">global</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">external_labels</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">clustername</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Test01\"</span>\r\n      <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Test\"</span>\r\n  <span class=\"token key atrule\">defaultFlagsOverride</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>enable<span class=\"token punctuation\">-</span>feature=agent\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>config.file=/etc/config/prometheus.yaml\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>web.enable<span class=\"token punctuation\">-</span>lifecycle\r\n  <span class=\"token key atrule\">remoteWrite</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"https://prometheus-server.&lt;domain>/api/v1/write\"</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>In my opinion utilising the Prometheus agent is the simplests way to monitor multiple clusters and send the data to a centralised server for use to query. The information in this blog should help point you in the right direction to set this up or at least let you think on how to implement this. A more detailed blog regarding Prometheus agent in general can be found <a href=\"https://prometheus.io/blog/2021/11/16/agent/\">here</a>.</p>","categories":["Monitoring","Kubernetes","AKS"],"date":"October 01, 2023","description":"Monitoring multiple clusters","id":"86fafd76-43f6-530e-a32e-a0c572c845ad","keywords":["Monitoring","Prometheus","Kubernetes","AKS","Multi-region","Multi-cluster","Blog"],"slug":"/PrometheusMultiClusterMonitoring/","title":"Prometheus Multi-clustered Monitoring","readingTime":{"text":"4 min read"}},"listingPagePath":"/blog"}},"staticQueryHashes":["172304273","1764120992","2442753764","2572006233","3525841079","513457919","540466502","597217301","948380417"],"slicesMap":{}}